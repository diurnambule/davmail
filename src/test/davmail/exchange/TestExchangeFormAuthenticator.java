package exchange;

import davmail.exchange.auth.ExchangeFormAuthenticator;
import junit.framework.Assert;
import junit.framework.TestCase;
import org.apache.commons.httpclient.HttpClient;
import org.apache.commons.httpclient.HttpMethod;
import org.apache.commons.httpclient.NameValuePair;
import org.apache.commons.httpclient.URI;
import org.apache.commons.httpclient.methods.PostMethod;

import org.mockito.Mock;
import org.mockito.Mockito;
import org.mockito.MockitoAnnotations;
import org.mockito.invocation.InvocationOnMock;
import org.mockito.runners.MockitoJUnitRunner;
import org.mockito.stubbing.Answer;

import java.io.ByteArrayInputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.StringReader;


public class TestExchangeFormAuthenticator extends TestCase {
    

    public void testBuildLogonMethod2ndFormAuthWsdl() throws IOException {

        //Given
        ExchangeFormAuthenticator efa = new ExchangeFormAuthenticator();

        HttpClient client = Mockito.mock(HttpClient.class);
        PostMethod method = Mockito.mock(PostMethod.class);

        InputStream is = new ByteArrayInputStream("<html><head><title>Working...</title></head><body><form method=\"POST\" name=\"hiddenform\" action=\"https://mail.vd.ch:443/owa/\"><input type=\"hidden\" name=\"wa\" value=\"wsignin1.0\" /><input type=\"hidden\" name=\"wresult\" value=\"&lt;t:RequestSecurityTokenResponse xmlns:t=&quot;http://schemas.xmlsoap.org/ws/2005/02/trust&quot;>&lt;t:Lifetime>&lt;wsu:Created xmlns:wsu=&quot;http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd&quot;>2019-04-13T06:35:39.122Z&lt;/wsu:Created>&lt;wsu:Expires xmlns:wsu=&quot;http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd&quot;>2019-04-13T14:35:39.122Z&lt;/wsu:Expires>&lt;/t:Lifetime>&lt;wsp:AppliesTo xmlns:wsp=&quot;http://schemas.xmlsoap.org/ws/2004/09/policy&quot;>&lt;wsa:EndpointReference xmlns:wsa=&quot;http://www.w3.org/2005/08/addressing&quot;>&lt;wsa:Address>https://mail.vd.ch/owa/&lt;/wsa:Address>&lt;/wsa:EndpointReference>&lt;/wsp:AppliesTo>&lt;t:RequestedSecurityToken>&lt;saml:Assertion MajorVersion=&quot;1&quot; MinorVersion=&quot;1&quot; AssertionID=&quot;_ba503f0a-8eb8-4964-baeb-d04c475019a3&quot; Issuer=&quot;http://ssauth.vd.ch/adfs/services/trust&quot; IssueInstant=&quot;2019-04-13T06:35:39.122Z&quot; xmlns:saml=&quot;urn:oasis:names:tc:SAML:1.0:assertion&quot;>&lt;saml:Conditions NotBefore=&quot;2019-04-13T06:35:39.122Z&quot; NotOnOrAfter=&quot;2019-04-13T14:35:39.122Z&quot;>&lt;saml:AudienceRestrictionCondition>&lt;saml:Audience>https://mail.vd.ch/owa/&lt;/saml:Audience>&lt;/saml:AudienceRestrictionCondition>&lt;/saml:Conditions>&lt;saml:AttributeStatement>&lt;saml:Subject>&lt;saml:SubjectConfirmation>&lt;saml:ConfirmationMethod>urn:oasis:names:tc:SAML:1.0:cm:bearer&lt;/saml:ConfirmationMethod>&lt;/saml:SubjectConfirmation>&lt;/saml:Subject>&lt;saml:Attribute AttributeName=&quot;primarysid&quot; AttributeNamespace=&quot;http://schemas.microsoft.com/ws/2008/06/identity/claims&quot;>&lt;saml:AttributeValue>S-1-5-21-2326432687-1419127354-3173672845-119464&lt;/saml:AttributeValue>&lt;/saml:Attribute>&lt;saml:Attribute AttributeName=&quot;upn&quot; AttributeNamespace=&quot;http://schemas.xmlsoap.org/ws/2005/05/identity/claims&quot;>&lt;saml:AttributeValue>v8lir4@ad.etat-de-vaud.ch&lt;/saml:AttributeValue>&lt;/saml:Attribute>&lt;/saml:AttributeStatement>&lt;saml:AuthenticationStatement AuthenticationMethod=&quot;urn:oasis:names:tc:SAML:2.0:ac:classes:PasswordProtectedTransport&quot; AuthenticationInstant=&quot;2019-04-13T06:35:39.244Z&quot;>&lt;saml:Subject>&lt;saml:SubjectConfirmation>&lt;saml:ConfirmationMethod>urn:oasis:names:tc:SAML:1.0:cm:bearer&lt;/saml:ConfirmationMethod>&lt;/saml:SubjectConfirmation>&lt;/saml:Subject>&lt;/saml:AuthenticationStatement>&lt;ds:Signature xmlns:ds=&quot;http://www.w3.org/2000/09/xmldsig#&quot;>&lt;ds:SignedInfo>&lt;ds:CanonicalizationMethod Algorithm=&quot;http://www.w3.org/2001/10/xml-exc-c14n#&quot; />&lt;ds:SignatureMethod Algorithm=&quot;http://www.w3.org/2001/04/xmldsig-more#rsa-sha256&quot; />&lt;ds:Reference URI=&quot;#_ba503f0a-8eb8-4964-baeb-d04c475019a3&quot;>&lt;ds:Transforms>&lt;ds:Transform Algorithm=&quot;http://www.w3.org/2000/09/xmldsig#enveloped-signature&quot; />&lt;ds:Transform Algorithm=&quot;http://www.w3.org/2001/10/xml-exc-c14n#&quot; />&lt;/ds:Transforms>&lt;ds:DigestMethod Algorithm=&quot;http://www.w3.org/2001/04/xmlenc#sha256&quot; />&lt;ds:DigestValue>ADuU9EhYYU1jb421kYE1igISsQ3A8wH9ml3zVhupKZM=&lt;/ds:DigestValue>&lt;/ds:Reference>&lt;/ds:SignedInfo>&lt;ds:SignatureValue>WYs/g4Um/1z1jXZgjChfutIETQ9cd9irKIgrE3BJPehxDjiRpO/BNV1HQJ2HwxmAMXhKS279BgsV7zTSOKOCcEUlizvfkABEQNFXnseVDvEDcSdbGIXJHhPBOSPiQcKIfHhrxWUUPYn0mdz9yRx6Vap2d+Pzpx7h5TWz0PiKE53KVD86ydHuqTnyBlySA8XXejUGFSY1IIuQ6YBfmBTdhr7xU2Op3jHL3eqk1IfuMvXKW/PbUoWzF0eZQOajFL4xFC36QgIPLbJgwaf0QPXjnSt1c7H18L5FId9zilSyF2scbasCIiKm2Jtm2g+7HFYA5v1+ylCP+XSM2GdzI/ExfA==&lt;/ds:SignatureValue>&lt;KeyInfo xmlns=&quot;http://www.w3.org/2000/09/xmldsig#&quot;>&lt;X509Data>&lt;X509Certificate>MIIC1DCCAbygAwIBAgIQaopUlE+RtoRHwObhrc4BCzANBgkqhkiG9w0BAQsFADAmMSQwIgYDVQQDExtBREZTIFNpZ25pbmcgLSBzc2F1dGgudmQuY2gwHhcNMTgwMjE0MTM0ODM3WhcNMjgwMjEyMTM0ODM3WjAmMSQwIgYDVQQDExtBREZTIFNpZ25pbmcgLSBzc2F1dGgudmQuY2gwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCPg9j95vEROpSEiGLIgasHjer/Qcxg62AwPcDBiZAN+yEEd2hXE2gjZUOhYbP4POpzUKKh7pCOr05Avn+jjvQqJpMDRTpmbzPLMqs4FP6SJNk1sZ4dIDP4k3IfsaptQlOwpzcxOE2NQTStZ67S2WKgTjeup+lJdFCBQy/8b6oBtNHGsgVwROL3ZJQZOsSdGNVPExx4XN5WNbbc75G17Uzg6eEdgD9QSg7XymkGlofBF3ksaIRIWayN6pIkdy1RYWMyZ2f7ERFMlUIXhxFabxNybXTlW4jxorbVi8RohVidZIG1yj58GXwh+RFBnTNymne/Ux7Wxy20m1Fjt/Sa/MZzAgMBAAEwDQYJKoZIhvcNAQELBQADggEBAG/xFEEw1R8SmWbyRaDBkXlV3ByBBjYa6sxfAH6wrJw2GvAXgVAhUtTTxkB95YQ8xKqLunhrJjJlZVPqoV7VSLcSP65o7DnWDMJG/bGz9co1hQVBI84hbp8HqBphudnYBz5gvv4rW/k+mSJZkNpd4T9ISYumVt6ujcCSuZmuAEIBjow/5sSAM0V7Z9JTxgJcByL1rLgI9Hey5BIYpq113mYS1YL0fzQUCncnZIiL3nvuMrZo2tjQt7YRwjBoUdqFSkKwUyFtlKlihOFSbaixE0rjsmRKJWKI/evvVV3ovyIMTmR78sNmTjqlmXs8++4vnOa7ksroe4jlaKXuY9pHohw=&lt;/X509Certificate>&lt;/X509Data>&lt;/KeyInfo>&lt;/ds:Signature>&lt;/saml:Assertion>&lt;/t:RequestedSecurityToken>&lt;t:TokenType>urn:oasis:names:tc:SAML:1.0:assertion&lt;/t:TokenType>&lt;t:RequestType>http://schemas.xmlsoap.org/ws/2005/02/trust/Issue&lt;/t:RequestType>&lt;t:KeyType>http://schemas.xmlsoap.org/ws/2005/05/identity/NoProofKey&lt;/t:KeyType>&lt;/t:RequestSecurityTokenResponse>\" /><input type=\"hidden\" name=\"wctx\" value=\"rm=0&amp;id=passive&amp;ru=%2fowa%2f%3fauthRedirect%3dtrue\" /><noscript><p>Script is disabled. Click Submit to continue.</p><input type=\"submit\" value=\"Submit\" /></noscript></form><script language=\"javascript\">window.setTimeout('document.forms[0].submit()', 0);</script></body></html>".getBytes("UTF-8"));
        Mockito.when(method.getResponseBodyAsStream()).thenReturn(is);
        Mockito.when(method.getURI()).thenReturn(new URI("https://mail.vd.ch:443/owa/",false));


        //When
        PostMethod resultMethod = (PostMethod) efa.buildLogonMethod(client,method);

        //Then
        //Assert.assertEquals("a","b");
        Assert.assertEquals("<t:RequestSecurityTokenResponse+xmlns:t=\"http://schemas.xmlsoap.org/ws/2005/02/trust\"><t:Lifetime><wsu:Created+xmlns:wsu=\"http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd\">2019-04-13T06:35:39.122Z</wsu:Created><wsu:Expires+xmlns:wsu=\"http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd\">2019-04-13T14:35:39.122Z</wsu:Expires></t:Lifetime><wsp:AppliesTo+xmlns:wsp=\"http://schemas.xmlsoap.org/ws/2004/09/policy\"><wsa:EndpointReference+xmlns:wsa=\"http://www.w3.org/2005/08/addressing\"><wsa:Address>https://mail.vd.ch/owa/</wsa:Address></wsa:EndpointReference></wsp:AppliesTo><t:RequestedSecurityToken><saml:Assertion+MajorVersion=\"1\"+MinorVersion=\"1\"+AssertionID=\"_ba503f0a-8eb8-4964-baeb-d04c475019a3\"+Issuer=\"http://ssauth.vd.ch/adfs/services/trust\"+IssueInstant=\"2019-04-13T06:35:39.122Z\"+xmlns:saml=\"urn:oasis:names:tc:SAML:1.0:assertion\"><saml:Conditions+NotBefore=\"2019-04-13T06:35:39.122Z\"+NotOnOrAfter=\"2019-04-13T14:35:39.122Z\"><saml:AudienceRestrictionCondition><saml:Audience>https://mail.vd.ch/owa/</saml:Audience></saml:AudienceRestrictionCondition></saml:Conditions><saml:AttributeStatement><saml:Subject><saml:SubjectConfirmation><saml:ConfirmationMethod>urn:oasis:names:tc:SAML:1.0:cm:bearer</saml:ConfirmationMethod></saml:SubjectConfirmation></saml:Subject><saml:Attribute+AttributeName=\"primarysid\"+AttributeNamespace=\"http://schemas.microsoft.com/ws/2008/06/identity/claims\"><saml:AttributeValue>S-1-5-21-2326432687-1419127354-3173672845-119464</saml:AttributeValue></saml:Attribute><saml:Attribute+AttributeName=\"upn\"+AttributeNamespace=\"http://schemas.xmlsoap.org/ws/2005/05/identity/claims\"><saml:AttributeValue>v8lir4@ad.etat-de-vaud.ch</saml:AttributeValue></saml:Attribute></saml:AttributeStatement><saml:AuthenticationStatement+AuthenticationMethod=\"urn:oasis:names:tc:SAML:2.0:ac:classes:PasswordProtectedTransport\"+AuthenticationInstant=\"2019-04-13T06:35:39.244Z\"><saml:Subject><saml:SubjectConfirmation><saml:ConfirmationMethod>urn:oasis:names:tc:SAML:1.0:cm:bearer</saml:ConfirmationMethod></saml:SubjectConfirmation></saml:Subject></saml:AuthenticationStatement><ds:Signature+xmlns:ds=\"http://www.w3.org/2000/09/xmldsig#\"><ds:SignedInfo><ds:CanonicalizationMethod+Algorithm=\"http://www.w3.org/2001/10/xml-exc-c14n#\"+/><ds:SignatureMethod+Algorithm=\"http://www.w3.org/2001/04/xmldsig-more#rsa-sha256\"+/><ds:Reference+URI=\"#_ba503f0a-8eb8-4964-baeb-d04c475019a3\"><ds:Transforms><ds:Transform+Algorithm=\"http://www.w3.org/2000/09/xmldsig#enveloped-signature\"+/><ds:Transform+Algorithm=\"http://www.w3.org/2001/10/xml-exc-c14n#\"+/></ds:Transforms><ds:DigestMethod+Algorithm=\"http://www.w3.org/2001/04/xmlenc#sha256\"+/><ds:DigestValue>ADuU9EhYYU1jb421kYE1igISsQ3A8wH9ml3zVhupKZM=</ds:DigestValue></ds:Reference></ds:SignedInfo><ds:SignatureValue>WYs/g4Um/1z1jXZgjChfutIETQ9cd9irKIgrE3BJPehxDjiRpO/BNV1HQJ2HwxmAMXhKS279BgsV7zTSOKOCcEUlizvfkABEQNFXnseVDvEDcSdbGIXJHhPBOSPiQcKIfHhrxWUUPYn0mdz9yRx6Vap2d+Pzpx7h5TWz0PiKE53KVD86ydHuqTnyBlySA8XXejUGFSY1IIuQ6YBfmBTdhr7xU2Op3jHL3eqk1IfuMvXKW/PbUoWzF0eZQOajFL4xFC36QgIPLbJgwaf0QPXjnSt1c7H18L5FId9zilSyF2scbasCIiKm2Jtm2g+7HFYA5v1+ylCP+XSM2GdzI/ExfA==</ds:SignatureValue><KeyInfo+xmlns=\"http://www.w3.org/2000/09/xmldsig#\"><X509Data><X509Certificate>MIIC1DCCAbygAwIBAgIQaopUlE+RtoRHwObhrc4BCzANBgkqhkiG9w0BAQsFADAmMSQwIgYDVQQDExtBREZTIFNpZ25pbmcgLSBzc2F1dGgudmQuY2gwHhcNMTgwMjE0MTM0ODM3WhcNMjgwMjEyMTM0ODM3WjAmMSQwIgYDVQQDExtBREZTIFNpZ25pbmcgLSBzc2F1dGgudmQuY2gwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCPg9j95vEROpSEiGLIgasHjer/Qcxg62AwPcDBiZAN+yEEd2hXE2gjZUOhYbP4POpzUKKh7pCOr05Avn+jjvQqJpMDRTpmbzPLMqs4FP6SJNk1sZ4dIDP4k3IfsaptQlOwpzcxOE2NQTStZ67S2WKgTjeup+lJdFCBQy/8b6oBtNHGsgVwROL3ZJQZOsSdGNVPExx4XN5WNbbc75G17Uzg6eEdgD9QSg7XymkGlofBF3ksaIRIWayN6pIkdy1RYWMyZ2f7ERFMlUIXhxFabxNybXTlW4jxorbVi8RohVidZIG1yj58GXwh+RFBnTNymne/Ux7Wxy20m1Fjt/Sa/MZzAgMBAAEwDQYJKoZIhvcNAQELBQADggEBAG/xFEEw1R8SmWbyRaDBkXlV3ByBBjYa6sxfAH6wrJw2GvAXgVAhUtTTxkB95YQ8xKqLunhrJjJlZVPqoV7VSLcSP65o7DnWDMJG/bGz9co1hQVBI84hbp8HqBphudnYBz5gvv4rW/k+mSJZkNpd4T9ISYumVt6ujcCSuZmuAEIBjow/5sSAM0V7Z9JTxgJcByL1rLgI9Hey5BIYpq113mYS1YL0fzQUCncnZIiL3nvuMrZo2tjQt7YRwjBoUdqFSkKwUyFtlKlihOFSbaixE0rjsmRKJWKI/evvVV3ovyIMTmR78sNmTjqlmXs8++4vnOa7ksroe4jlaKXuY9pHohw=</X509Certificate></X509Data></KeyInfo></ds:Signature></saml:Assertion></t:RequestedSecurityToken><t:TokenType>urn:oasis:names:tc:SAML:1.0:assertion</t:TokenType><t:RequestType>http://schemas.xmlsoap.org/ws/2005/02/trust/Issue</t:RequestType><t:KeyType>http://schemas.xmlsoap.org/ws/2005/05/identity/NoProofKey</t:KeyType></t:RequestSecurityTokenResponse>",
                resultMethod.getParameter("wresult").getValue());
    }

}